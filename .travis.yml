services:
- docker
env:
  global:
  - secure: ir73jdHOaZ16A3LeKHkNXr0sIIGXpecRMz5TmW3yeU5o5EzSLZj1n8e2fzogFPpdDmXR5PKR/9g1U2fjlpGFuQkZICjOraGOUC5NSe3oKo+tYu5f0gZ7qf8Qk8/Z1YavAiUsaBzh2ZsvIZQG79ePFyKNSlf17HG3QEHgBZSYVoZDY8106/Z9tsnngIxjdbBivmySq5meLDN7rHWLt3blNfOlIA6lYuB6n5/Tw74hhVx/8kViHiXtEteeVBCz7QT84toCC17CuKaqVfXP+gYdodUCJLOwk84TOiKvoH0QHmqBqeENFbF/N8+4Jsh9njau2uUnGKNxZ6eslb7EeUWHDqKmFDZyX5jZv2g9Dai42yrdODuLwCuHTU6fPsIh/rp5Zd++g761l+wvvkza+1iMMve5tEvFc6ucNdyeH0wG8aKQHIJy1Shtq0ZPUMTWwUYsX4Extht/t/7fJAqiiAM9A0nkdkvjM8OVySw9uru3yvcRFAm3mFwejocTtO8UNVt7Lqmplc1Y1NgTorcYAfyzpF57mqK+yq3baK3oR91u+Br1SfR9Xx9lULOuKQWOrQRhq9bM4W8+lVf9PZdY/geZrqEj6OimvuetwirhjG10eTW24lloeMESlclo9QQC2G0nfkMqp8r+FiugRHOZGHkGQfcl1W8huk9w6D+7PlC7gf0=
  - secure: x1UlIzjMX0IQxlH8+yQ8NWrXqP6dDvQUsLdsNWCtVZIUhnEpwY7kW22YmFNTJ+Wt0veYuDiKS6L4V0rSstOD7Jil9WAXd7om6EW0keyZ0Aokxe/4cftfw3iRoBGLzTagtHI0XCMD5bz5Jmnk/qYX8+fUVRZ0VzRvYdTQhy8Xu5avTE4gHpKUlCfWsvwWf5IFmWrafgBhbIT/qZ0qLq33yxdY/UpOkzodg3OBkKMiBXhSwt3iNecjhTOhE5oAFdK68L2sys2Ld3z++Th5A7BSeop6G5dXbQj9CST9Rvqp4gbEsSzg7gp9IsVf2Jpee0/r2iyjDl2OQn3tCX4CQP30XsNIR2KlFXGlKWo37Svzt7/eRNGFnXIaHeboqM1KOwMVRdTAM+tnoO7ndJ/WlXfhiXWRNEMme6Z7ashEbXWT7oGotnoTBdzQmapkAAgTIaZFrc/OFF7voh5npqh1ZLAcQeeBwO7mSFL+ZIeOoGIuhd8rF6yJ/h4QDfngS/1ipeQ8hRfC77nELUM1pcEh2WyElQ1bsXiNlnJE2FWk7fsks2hiBBtK5MDQkDGkQ2r28aEfz6/WZxtcjKPWAuT3BkYiv+KQrE/wdYSXUKxujz7bZHVd8CaPuXTsXhS7KSVhnVlVBT6OycNezhCniZsmgY+sqmbEN/yw2iDtPaGZKZH23M8=
  - secure: MQgZje6ZyMQgj6MOoLNgVFVmXTsRtcGHu6RiHx4f0/vSx6ZHsa37gNfTMkFpsRmAdg5VtRCCmZurIcMz8zrfLJF/WGej/5VJRjFwfR+TgLbl7htZg3C9g88Li86gBF78vcclAI9ye//OA+vP9eCafuOhZz6+hP6MZG8gFoL6tRFS7QlAJxRebZi/PrWbxNCTkgt0ilZmWkZ+pQs5bJdVmS0ZEgjpWfPUNNazlMMxYqC/n+R7mDi99rTTJsUyO8TVnku18URMSTBD3Ot0Ulo7BmlKsHHdaa4K/PYvFNbc5MsVAwUl4Iros9jDmpsp5nWPJ5xrS++6uGN+GfSZccJ91z3yeeVSBxS5PJAePjFLI+xsOOPSGhyTK2RiuMQnjupBkKpr2Arfc0SL+JG8lm/LCJn+vpEFzLy4x12VgQgTHgDgrdTphIlCfLdVap6XwCM9lZ0qy5Pz8MpXYK76+FNZ0oOhrC3ZI7USbi9lblzo3My+ZSrh79KnSDZ81tnLAlf1ULWMzKzRfGUGwEUq7kxKVeNqvIQaQg3aL9Y057aDpMPdYGuhzbCWHGnH6I3YJ2cieEwDmXLy5YSzn3AECFljF4EITF5ilQaYueDuiJcI/Un3grOUAO/ILDX7pItQkqUU0h+VMUi+pTsOvxRlvbeu+H0XDM0kW3fZ3Bjj0+LUGo4=
  - secure: ULzj8q+l66HeRAyOXu9k5988DXjrlEqS3sMBtSFxOA6JShm6MKqqj2/W3jFbAX6fz1ujpSuh6DCEjFMIAM3jZ+SHDWDwb7msww4LYDxtP/VMo66t2XpKgL1LbdEKNPYQAtbn4wAvDrUyOTtzFxnwcZEKd3NOlegX8ZjwJjuOLS9OmMUfFWPbD7a7Vt6W1MmqSj87oZu+Y2+XVUJnKGszNMZH2SoKvDXIVAbpgxwBR2Nkdmtc9SMU6eTDDhV1Hd4A7RG8pMqBle0P2/ifMqVP40cTA5WCGuydXyISdlneDAu3I0AL1Bg3Ksp/FyTcoI4k0QNvy82VeR5rDYtlHWiSI5HLaSatvYkfqwqq0z3RDprgmRGox37vGBkg3M6/fYw1Ep3flyXk3be3vbsxlQBtNcNDhxXHt//zHVatln3vx9lazJ5cIKJpSLz0i3xg4Xg/GkwTSdJcag7fqxh6jLkh7o43dWwpvKvV8KN5p8HmhQhvYGFqkM9hvxb07OKHWhdhy7vWmniLD9tANL99YQnkrYfDRKMxXluGF9+sFsNakyfCb5rsYqSd/9fPtsFtPnXzO/3w1XxZXVGZYi6xwASZY1/Tg1mY/1fxEWjW7QpjI2IY/kU97Me2u8nf2gI8MrwY0aHdjOb9WgGU1kf/m6RAX6uWJkxu5ACLdJnvUyMweLY=
  - secure: fRgFr1Ln70u4LumihjWGPnyDJ6aV1eMEsMRui1/sAJtGXfAJgooTHyiAZ8bt45GikbsRmJlXSuFbOnf+5gubF9BQBvdHYfpoYXGPXKclFPzBwMlGaO8XC5XsMXgVhlLocDIWZYfT1NVAKteu7KkgJ8zCc2bl9tWWxDN4NFkuEXeTSBmy1+BtC49agcLCcOqYP7s3UPOqouMT8Ubh6UPTesqnyQjpW4aXRrKE8QP8hqdNkohq2cL+MS4pwNLBRRzpMSfR+blrxR5wRP/iJMCskKg0e1Nrx7ND7UKjtpBhZqCKxuSLTJyR0nedkejxE13ZZ+wBtyJO+4shmCTAgGPaW7VYSCgZYWQzIdC14pMM+1SeK6MRBgOdGM/caOQ/DyCeONB2vAaOjUEBGikapQkkzyfi/kb2Y+kY/u9wvKIYnR/0wD7FohBK6d9SPnbzsiGnOB2lu8oVLbjdzUU9cdKuh5Ft/hwUdkmmIzsHlZ5Rlan5FF8ycORFaXRTd/9r/vtWIiuVzTokjM418Dix7/ZcYbEIuj4ZRVNYRp9xwu3ifSLDPZHfCN2kJLVhBWwP1vWlHSe+tbFFfgXbL8Nc1Pib/1WYfK0osjLtgWOX9AIXox7YS1gX+FoZTBZ9jY1pcIlnKfJAsOo81Y26GkveC2LS97AF1fB5ifBFk7GbGNRp00M=
  - secure: sFfAwUFFf7RPkK3D2daJWLIoKjNtvTRDX85BgAC1RjiWz0uKf4u4UsicI0M25ZFZVyJqNhFkHXdDxQjGduNz1DUu8rPlBlAVyADgmAmgYvcoASdMSQIosiS+eaCFLHbuLAfKEPMYCjOtu1bfRxP7+DGtrr3xqjnVO6dpAojzm86KNQ+qRfjFXCSK+E6uDC1P0n3lzt/s3KL3V4csCP9TSaDt2VPyDZPDc8ROmlf77MnJ8UreASMF66ieSQVOUD4Orhjah5NJXlkng9yGjF2GbuAa0qjrKjMoUsLIlENShtKCgAgzAs6WCt24dvvEK/9rcLL4+tDyEC0hiUFStxOU+DnDZlvYExxGLoA9yUfMA6JkDNXNFpE7qoVVL+c1Ep6F3/fYwsxFnf3LjAXb5CdWzxyPHXHC0DAq0UCeKsPSZZXlmI62Lr/MwcqvAN1gGouU0dClPiAOhdesCFAmOuWukX+bZrLFWxm7aPyosi1L5ZM478OVaxOM+c9SxFtnMfTcxKc97njJAUu0OZq7YKig1B/jdoNoSa2ag6yCp8Zl7ASwKsm5ixlYW4B2UKJ+doX5sjWARHhjZYmN6UxA2FbSbQXAMDxC5r0JDG81MAh3UPBHu9NUdY37Cj2XgksKYT5L2AT/yp2JM9URI/t1ExS4DOW/xs6yAI+Bo/PuAcq6K3Q=
script:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
- docker build --tag todo-app:test --target test .
- docker run --env-file .env.test todo-app:test todo_app/tests
- docker run --env BOARDID --env KEY --env TOKEN todo-app:test todo_app/tests_e2e

before_deploy:
  provider: script
  script:
  - heroku container:login
  - docker build --tag $DOCKER_USERNAME/todo-production:latest --target production .
  - docker push $DOCKER_USERNAME/todo-production:latest
  - docker tag $DOCKER_USERNAME/todo-production:latest registry.heroku.com/lwtodoapp-production/web
  - docker push registry.heroku.com/lwtodoapp-production/web


deploy:
  provider: script
  api_key:
    secure: Q7h6hWCxP4SeeKBa9zXUPXcy/sv19QlMFqfYTgGpi95QYt4cNQult5PN1uANFKJuGIv5lB2WUbv97nqlI1DWHXLQ07LsYDmlGCsUUUyfghc/Ijk0EGcqXrhcQYcU5VBl7T/3IxdkWfoXjv/BMB6opqpjgfJ/sMp+MdjfnYTXvyaHW3gMyzuYnizfeDtF0ZxCDhgAMG+YZZ2MNWyx0k8OF0DOZFSKA0WJtvVDSanQheVF7T81dI+FPS5vp1jT5jKtg0/zz1lCF07H40sPHCXYkPFH/PGHsdT9+QBvEBuqbpzUm0ki0UTt2R22IMcjO1dto5Md2RJiOTs/69LBmCcBxWf8xVUGmR9VctY5PqAjq6WEOmU4aBepyAT6S81fgBJ23ZzV4p31/4ndrYHHXPHe2A1bsai5HZewDLl0MQUXxwQ2hPPry45fBDyuvmDcXuEdrAtv9YNb3kV/Hy4yu2AL8jMO/c0HdBz49b+MACAc1XD3SGouCdZ5JJ8apD7eaR9HDW9HfHsN+p26JJyQy7uW1CwLHsKqDl602D1XujtfwtGmBtIvTR4ouQ0Ib8X4gxLeOghlem+ZJzlz+OpGY9CD1XDFPdIIU3eN0hD1/C/EnBwN0d3KDru8AUL4wKwuAQ9gbWhzr+aGot8NR0eiGPclZqc2f6k2FSuzRPD4AMhdPOs=
  script:
  - heroku container:release --app lwtodoapp-production web
  on:
    branch: module8
