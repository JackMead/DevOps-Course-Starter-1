services:
- docker
env:
  global:
  
  - secure: ULzj8q+l66HeRAyOXu9k5988DXjrlEqS3sMBtSFxOA6JShm6MKqqj2/W3jFbAX6fz1ujpSuh6DCEjFMIAM3jZ+SHDWDwb7msww4LYDxtP/VMo66t2XpKgL1LbdEKNPYQAtbn4wAvDrUyOTtzFxnwcZEKd3NOlegX8ZjwJjuOLS9OmMUfFWPbD7a7Vt6W1MmqSj87oZu+Y2+XVUJnKGszNMZH2SoKvDXIVAbpgxwBR2Nkdmtc9SMU6eTDDhV1Hd4A7RG8pMqBle0P2/ifMqVP40cTA5WCGuydXyISdlneDAu3I0AL1Bg3Ksp/FyTcoI4k0QNvy82VeR5rDYtlHWiSI5HLaSatvYkfqwqq0z3RDprgmRGox37vGBkg3M6/fYw1Ep3flyXk3be3vbsxlQBtNcNDhxXHt//zHVatln3vx9lazJ5cIKJpSLz0i3xg4Xg/GkwTSdJcag7fqxh6jLkh7o43dWwpvKvV8KN5p8HmhQhvYGFqkM9hvxb07OKHWhdhy7vWmniLD9tANL99YQnkrYfDRKMxXluGF9+sFsNakyfCb5rsYqSd/9fPtsFtPnXzO/3w1XxZXVGZYi6xwASZY1/Tg1mY/1fxEWjW7QpjI2IY/kU97Me2u8nf2gI8MrwY0aHdjOb9WgGU1kf/m6RAX6uWJkxu5ACLdJnvUyMweLY=
  - secure: fRgFr1Ln70u4LumihjWGPnyDJ6aV1eMEsMRui1/sAJtGXfAJgooTHyiAZ8bt45GikbsRmJlXSuFbOnf+5gubF9BQBvdHYfpoYXGPXKclFPzBwMlGaO8XC5XsMXgVhlLocDIWZYfT1NVAKteu7KkgJ8zCc2bl9tWWxDN4NFkuEXeTSBmy1+BtC49agcLCcOqYP7s3UPOqouMT8Ubh6UPTesqnyQjpW4aXRrKE8QP8hqdNkohq2cL+MS4pwNLBRRzpMSfR+blrxR5wRP/iJMCskKg0e1Nrx7ND7UKjtpBhZqCKxuSLTJyR0nedkejxE13ZZ+wBtyJO+4shmCTAgGPaW7VYSCgZYWQzIdC14pMM+1SeK6MRBgOdGM/caOQ/DyCeONB2vAaOjUEBGikapQkkzyfi/kb2Y+kY/u9wvKIYnR/0wD7FohBK6d9SPnbzsiGnOB2lu8oVLbjdzUU9cdKuh5Ft/hwUdkmmIzsHlZ5Rlan5FF8ycORFaXRTd/9r/vtWIiuVzTokjM418Dix7/ZcYbEIuj4ZRVNYRp9xwu3ifSLDPZHfCN2kJLVhBWwP1vWlHSe+tbFFfgXbL8Nc1Pib/1WYfK0osjLtgWOX9AIXox7YS1gX+FoZTBZ9jY1pcIlnKfJAsOo81Y26GkveC2LS97AF1fB5ifBFk7GbGNRp00M=
  - secure: PibFR1FVG85JvDSxvRBGkCOImcff3twiKX5/5kVfTfXdon83Ce6R/DQ466AtRpcZ732Ob+H/UlIuGC1NlugwDZ8f587IUtbNYiU4qmScW+EzWzw35I7yAfI2SIyLgdt3zRFZFHEP6Ua/wj5PDk4bzw2O7HJb+X7CH6c+ex2nJhuzB0PGSRTiPUVNnenK1Bm0xCnouQC2KoEIH2Yq53zd7uF3OXzt8CJQRHckEAAY5FdYZNXuJYmXJk1HjE5j8POkOCbNCbG93KgSla5p+BZf2keYTV6sWWGtj6lHutIWQqtt6+EYxmeDJ1OF/GmhTGsXB/QlCcU+yJChjUsxaweMNv9/cHj82cZxJbCH2NLmiGMPv5+56Zpl5zlET01sP30MzFDl+8GwWB85KaQdZG67+SA55VTaMffyawxkq6jY3PUbIQrB4qq3ELTyrGvXO/8IITfrbB6hgYADZg/e51GVlwL79enPvbfcdtmv0rqDXOOv1iDhBu6qnx3Dfruw6qZZdJQnuROncOPjSafSsj4tdB7BUYgSZOU2qip7uqXg5XSHOcefZUPIUPtpA5A9bTFhetqwb8tUVFdSPDOWbmIoy5qZBAMptvCO45GHFaY6lZygNuOCKaSyhkxFmxXwgu1RyJl4J9PttbnJQ8agw96HpNrZb3fnvrX/0GoautEcT4s=
  - secure: EdxOlXrWkd2plWkxE7iKjPEH1h7R/KbHwQ0UCEEFpaUd4gFU3HzAgoeAZyDu7JjzuEGd3OwEQyzv7PrKeeBZMBDNKcyfZxv1ucAZ77kOfNJJCciPiEZ61W3l0W0rW4/CpRjvb92mHg+eTzJnGkbSeHJn7zby9e1AiAnkXMytjv+qslOrWRsmy1vOV9sYXuKDfNGaUiVYdl/enSr7u2Q2uJ1GNZUdWHXZiQkhnxUWCLrfoa8Zg4IAuQcW1VblEoXDazPtr4tI/7tNi5vL4yhutHiOa/eJjab7W60amuj7nf2IH0Rc2u2tw4+zbfZQdTcxvK2GpXz1npF4o8C/aU53A9hiC9DEwimfbUlQyCv5wmw2iIauhCk8HXCRWTwvIZMzhnxJdFR/tNqL/OYxAwNob7RyJq7ZJTWfnvTUFF+vs1lwmWPAnzuc8q67X5TpISfmlyOrz/JIMKxO2FWVuAnzyS7GhyigWNRwfE8Ok5lOr9/5aM1awTtcSmh2MSksi/KdF81DZphBpqSbfH2rG+NZmJ1Ek8Favjtgo89+zVr1jSX1tr9zoqX6FemUlmJdiFrmLSs18PKqxu04HB3hKfMRWxlZGwjJCOIAPBCYtTX8W7kQUT2UN1opX5aSuLPiPBHRKzGCHMPTb9nU9CmqCV4cS3uTIXqozVGXBiu6M5uNIbY=
  - secure: fIQB4t2EzJ081hsrqx2mdzXqde88YIMp9VD4UphC5Ky5gaqajIfXJfFumwjXRwgFyc2nA7A3GcQtWSP7kJ0tpqlLq4Lq6201K/BY62UIxQ18fW4wfvg8eX9LpPlcI4q8Js/6o1JdG3yWMFUFwwaAdm9z0ElX/uTUbISEPbdZ5YN6FXNTHIwXbTtXxK/DVfxw9C8RjFZs8PBs0i1Z01lPWl54qfB6/D5NEqCqSTnJ5mPhsismo8YWr2S7SCQ65g5l/ezp5KpbvMA3VuZEBG94FxkKPbzlhvsfklGjNDa6klKfmszBDiDx7LXpqofOOAlmtOvGw2AbzHXHk/7AhFLBfslwATwe1JZUetEErAmS4YaMXsuj77P5N2A+Qe+vUUhWcbq1Az7/KRf3fbp1yOJBHysiGPCk9asPV0Nk6mHi6pLzYHVXbsSLw6nELA/PXLM3dr9QKx0f6h1wnRWkJd6dFt7Vb9uuEi/LGvWgmniSzzLpZWQxw8/pZ5QpE6Dj5TJD95L1PiKEd7RtRbCnYfPeYvKFmSFl/rPFncrn4BukSUxrmH2uOuSGXbEBMmy703sM/p+CwqMGV8mwo2iHLghkTBzlqVt61K5kRxr1RNGNHhEjZLOWuKRPusVdEF67PnVQRhrOfD8PvbYCq2cA2TgTPRLmARdRIYwYULxaRCqoyjU=

script:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
- docker build --tag todo-app:test --target test .
- docker run --env-file .env.test todo-app:test todo_app/tests
- docker run --env MONGO_DB_CONNECTION --env MONGO_DB_NAME todo-app:test todo_app/tests_e2e

before_deploy:
  - heroku container:login
  - docker build --tag $DOCKER_USERNAME/todo-production:latest --target production .
  - docker push $DOCKER_USERNAME/todo-production:latest
  - docker tag $DOCKER_USERNAME/todo-production:latest registry.heroku.com/lwtodoapp-production/web
  - docker push registry.heroku.com/lwtodoapp-production/web

deploy:
  provider: script
  script: heroku container:release --app lwtodoapp-production web
  on:
    branch: master
