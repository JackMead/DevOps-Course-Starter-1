services:
- docker
env:
  global:
  
  - secure: ULzj8q+l66HeRAyOXu9k5988DXjrlEqS3sMBtSFxOA6JShm6MKqqj2/W3jFbAX6fz1ujpSuh6DCEjFMIAM3jZ+SHDWDwb7msww4LYDxtP/VMo66t2XpKgL1LbdEKNPYQAtbn4wAvDrUyOTtzFxnwcZEKd3NOlegX8ZjwJjuOLS9OmMUfFWPbD7a7Vt6W1MmqSj87oZu+Y2+XVUJnKGszNMZH2SoKvDXIVAbpgxwBR2Nkdmtc9SMU6eTDDhV1Hd4A7RG8pMqBle0P2/ifMqVP40cTA5WCGuydXyISdlneDAu3I0AL1Bg3Ksp/FyTcoI4k0QNvy82VeR5rDYtlHWiSI5HLaSatvYkfqwqq0z3RDprgmRGox37vGBkg3M6/fYw1Ep3flyXk3be3vbsxlQBtNcNDhxXHt//zHVatln3vx9lazJ5cIKJpSLz0i3xg4Xg/GkwTSdJcag7fqxh6jLkh7o43dWwpvKvV8KN5p8HmhQhvYGFqkM9hvxb07OKHWhdhy7vWmniLD9tANL99YQnkrYfDRKMxXluGF9+sFsNakyfCb5rsYqSd/9fPtsFtPnXzO/3w1XxZXVGZYi6xwASZY1/Tg1mY/1fxEWjW7QpjI2IY/kU97Me2u8nf2gI8MrwY0aHdjOb9WgGU1kf/m6RAX6uWJkxu5ACLdJnvUyMweLY=
  - secure: fRgFr1Ln70u4LumihjWGPnyDJ6aV1eMEsMRui1/sAJtGXfAJgooTHyiAZ8bt45GikbsRmJlXSuFbOnf+5gubF9BQBvdHYfpoYXGPXKclFPzBwMlGaO8XC5XsMXgVhlLocDIWZYfT1NVAKteu7KkgJ8zCc2bl9tWWxDN4NFkuEXeTSBmy1+BtC49agcLCcOqYP7s3UPOqouMT8Ubh6UPTesqnyQjpW4aXRrKE8QP8hqdNkohq2cL+MS4pwNLBRRzpMSfR+blrxR5wRP/iJMCskKg0e1Nrx7ND7UKjtpBhZqCKxuSLTJyR0nedkejxE13ZZ+wBtyJO+4shmCTAgGPaW7VYSCgZYWQzIdC14pMM+1SeK6MRBgOdGM/caOQ/DyCeONB2vAaOjUEBGikapQkkzyfi/kb2Y+kY/u9wvKIYnR/0wD7FohBK6d9SPnbzsiGnOB2lu8oVLbjdzUU9cdKuh5Ft/hwUdkmmIzsHlZ5Rlan5FF8ycORFaXRTd/9r/vtWIiuVzTokjM418Dix7/ZcYbEIuj4ZRVNYRp9xwu3ifSLDPZHfCN2kJLVhBWwP1vWlHSe+tbFFfgXbL8Nc1Pib/1WYfK0osjLtgWOX9AIXox7YS1gX+FoZTBZ9jY1pcIlnKfJAsOo81Y26GkveC2LS97AF1fB5ifBFk7GbGNRp00M=
  - secure: PibFR1FVG85JvDSxvRBGkCOImcff3twiKX5/5kVfTfXdon83Ce6R/DQ466AtRpcZ732Ob+H/UlIuGC1NlugwDZ8f587IUtbNYiU4qmScW+EzWzw35I7yAfI2SIyLgdt3zRFZFHEP6Ua/wj5PDk4bzw2O7HJb+X7CH6c+ex2nJhuzB0PGSRTiPUVNnenK1Bm0xCnouQC2KoEIH2Yq53zd7uF3OXzt8CJQRHckEAAY5FdYZNXuJYmXJk1HjE5j8POkOCbNCbG93KgSla5p+BZf2keYTV6sWWGtj6lHutIWQqtt6+EYxmeDJ1OF/GmhTGsXB/QlCcU+yJChjUsxaweMNv9/cHj82cZxJbCH2NLmiGMPv5+56Zpl5zlET01sP30MzFDl+8GwWB85KaQdZG67+SA55VTaMffyawxkq6jY3PUbIQrB4qq3ELTyrGvXO/8IITfrbB6hgYADZg/e51GVlwL79enPvbfcdtmv0rqDXOOv1iDhBu6qnx3Dfruw6qZZdJQnuROncOPjSafSsj4tdB7BUYgSZOU2qip7uqXg5XSHOcefZUPIUPtpA5A9bTFhetqwb8tUVFdSPDOWbmIoy5qZBAMptvCO45GHFaY6lZygNuOCKaSyhkxFmxXwgu1RyJl4J9PttbnJQ8agw96HpNrZb3fnvrX/0GoautEcT4s=
  - secure: p1/TOPFQlotVgV/XfRTEFCPEm9fdFxMm5IsG6EOF54xhflThVXrshQDSAiFGagT+tE8PPfySPSor9CQ7OyfgDt9WOrhNjd0ye2mLcjLztyJCdxH6LZc9cHK9V7W8mMD+YJFxMHUbWIMdDdDDBHob1OV5qp9TiKIQErSGcNDVR6e9ZTW0rseyxYAw2uLTK/SySpAaHt/cKrKQGE5NtrKWcFty3F5qzUu1piFTOtUyeUK4JCRxuOF2r8zpKn3PTEb74te6CGw7C8UakSlPA6g/7I5yKCMncPYeBDy1n5G1NQF4v5+ZcY6bw+yg3t97WDxEqS35JkZrJBWhagKd9WTD+zuRir84LVQd4HKsIqwPJJgbln4NEBJ+mp79JhE+/S8WY5vXaf6argJFjJtb2W3Tulqsu14akXatmLugSOTkxLBuYvylsKH9+9udFbmv3m6ZMG8wliSIqAUCqYiJBp3MRXlJy9J1G4TqVJjhAe80Tp5uQIkTdQIt0K8THBf6d88Ecd/9I2MksZciahlWPyD55Smm6GjQPBZc0FyMR5+wDHqD2XPpPCfqBpgMvSF/EDxPRxNUJzjHnYPyYeq4GXqQ0Shy9x6wAACdbZkVCbnLt1UO2RjhrXvKfwDeF0rWrh2W6HEt5gFy0fumxv1BdJ3dHccNvrYtrxCk8qGPQyhqawg=
  - secure: n0zugvwc5M+sDoms2r3ferQmbvgoUnlsTxeVQpYHZ6FTMiAUAEMnqHFu1v8Z5ilOkcj6zmaj/NWn7NmJwIocgfHoMWbjpQBw3ca0GKt+/F8DWU1KReilHJgHjiwpXGR9ue/Ky466K584A1E6JX1CbHl5N709/hQYXRjrky2DgkyXXV85f2lYlaxeNd+fl8188K4NOZOdWU7OH27VR4Tsf2rmyuNcu/PjKJiJ1VhyyE0/tWNmEYSciX/BB8CD7o2NeM58u1tY1KfEmFwOFYeFW8gv5Ot2wiZzwcqdRCjCngamn4Mr9LicJBxrABgAEwg+jCLFiBJ4j1rXGzglBpbbjz22c5WqF78GZnYrj236XHmOGx0QN56t5PIHmgthiDT+MzzV+4mfLQq1zva9bEEVdMMxncwYHClbHfzraFltg6t/qQFok37VNFOxRMQYgZT+k5YKZCawevGtCtIf6b78TA+EvKArPDQKADoTgLmEsxY0shwclYSiuGt8NOpbfiKKbdIxTif11nCeEnm0QvasNUXEuFNVEJ/0fxYbQdYaUeRGA2767ptHdyAXHAOV5iocghcu5Lok2hgRk2Qm1pkbfPKL/Z1iVLxyy6tBv1ougqoZznYClBbQqqOVU6wEwYraa7Rg581IWjhhqXATBoI5WU6g9TSmNo3qdO5Z9i6xS0E=

script:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
- docker build --tag todo-app:test --target test .
- docker run --env-file .env.test todo-app:test todo_app/tests
- docker run --env MONGO_DB_CONNECTION --env MONGO_DB_NAME todo-app:test todo_app/tests_e2e

before_deploy:
  - heroku container:login
  - docker build --tag $DOCKER_USERNAME/todo-production:latest --target production .
  - docker push $DOCKER_USERNAME/todo-production:latest
  - docker tag $DOCKER_USERNAME/todo-production:latest registry.heroku.com/lwtodoapp-production/web
  - docker push registry.heroku.com/lwtodoapp-production/web

deploy:
  provider: script
  script: heroku container:release --app lwtodoapp-production web
  on:
    branch: master
